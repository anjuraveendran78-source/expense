{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Reports & Analytics - Expense Tracker{% endblock %}

{% block content %}
<div class="animate-fade-in-up pb-10">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
    <div>
      <h1 class="text-2xl font-bold text-slate-800 dark:text-white">Analytics</h1>
      <p class="text-slate-500 dark:text-slate-400 text-sm">Visualize your financial performance</p>
    </div>
    <a href="{% url 'generate_pdf' %}"
      class="inline-flex items-center px-4 py-2 bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
      </svg>
      Download Report
    </a>
  </div>

  <!-- Filter Bar -->
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 p-4 mb-8">
    <form method="get" class="flex flex-wrap items-end gap-4">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Time Range</label>
        <select name="range" id="rangeSelect"
          class="w-full text-sm bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-700 dark:text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">Custom Date Range</option>
          <option value="this_month">This Month</option>
          <option value="last_6_months">Last 6 Months</option>
        </select>
      </div>

            <!-- Report Mode -->
      <div class="flex-1 min-w-[180px]">
        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">
          Report Mode
        </label>

        <select name="mode"
          class="w-full text-sm bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-700 dark:text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500">

          <option value="individual"
            {% if request.GET.mode == "individual" %}selected{% endif %}>
            Individual
          </option>

          <option value="family"
            {% if request.GET.mode == "family" %}selected{% endif %}>
            Family (Shared)
          </option>

        </select>
      </div>

      <div id="date-inputs" class="flex gap-4 flex-wrap">
        <div>
          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Start Date</label>
          <input type="date" name="start" id="startDate"
            class="text-sm bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-700 dark:text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">End Date</label>
          <input type="date" name="end" id="endDate"
            class="text-sm bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-700 dark:text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <button type="submit"
        class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
        Apply Filter
      </button>
    </form>
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div
      class="p-5 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/20">
      <p class="text-emerald-100 text-sm font-medium mb-1">Total Income</p>
      <h3 class="text-2xl font-bold">₹ {{ income }}</h3>
    </div>
    <div class="p-5 rounded-2xl bg-gradient-to-br from-red-500 to-red-600 text-white shadow-lg shadow-red-500/20">
      <p class="text-red-100 text-sm font-medium mb-1">Total Expense</p>
      <h3 class="text-2xl font-bold">₹ {{ expense }}</h3>
    </div>
    <!-- Total Income -->
    <div
      class="p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-lg border border-emerald-100 dark:border-slate-700 relative overflow-hidden group">
      <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
        <svg class="w-16 h-16 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
          </path>
        </svg>
      </div>
      <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Total Income</h3>
      <p class="text-3xl font-bold text-slate-800 dark:text-white">₹ {{ total_income }}</p>
      <div
        class="mt-2 text-xs font-medium text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 inline-block px-2 py-1 rounded-lg">
        +12% from last month
      </div>
    </div>

    <!-- Total Expense -->
    <div
      class="p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-lg border border-red-100 dark:border-slate-700 relative overflow-hidden group">
      <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
        <svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6">
          </path>
        </svg>
      </div>
      <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Total Expense</h3>
      <p class="text-3xl font-bold text-slate-800 dark:text-white">₹ {{ total_expense }}</p>
      <div
        class="mt-2 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 inline-block px-2 py-1 rounded-lg">
        -5% from last month
      </div>
    </div>

    <!-- Net Balance -->
    <div
      class="p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-lg border border-blue-100 dark:border-slate-700 relative overflow-hidden group">
      <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
        <svg class="w-16 h-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3">
          </path>
        </svg>
      </div>
      <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Net Balance</h3>
      <p class="text-3xl font-bold text-slate-800 dark:text-white">₹ {{ credit_score }}</p>
      <div
        class="mt-2 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 inline-block px-2 py-1 rounded-lg">
        Healthy
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Monthly Trend -->
    <div
      class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-gray-100 dark:border-slate-700 p-6 lg:col-span-2">
      <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-6">Income vs Expense Trend</h3>
      <div class="relative w-full h-80">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>

    <!-- Category Breakdown -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-gray-100 dark:border-slate-700 p-6">
      <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-6">Spending by Category</h3>
      <div class="relative w-full h-64 flex justify-center">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <!-- Quick Stats -->
    <div
      class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-gray-100 dark:border-slate-700 p-6 flex flex-col justify-center items-center text-center">
      <div class="w-20 h-20 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mb-4">
        <svg class="w-10 h-10 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
      </div>
      <h3 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-1" id="monthsCount">0</h3>
      <p class="text-slate-500 dark:text-slate-400 font-medium">Months Analyzed</p>
    </div>

  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  window.onload = function () {
    /* =================== CHART DATA =================== */
    const months = JSON.parse("{{ months_json|escapejs }}");
    const incomeData = JSON.parse("{{ income_json|escapejs }}");
    const expenseData = JSON.parse("{{ expense_json|escapejs }}");
    const categoryLabels = JSON.parse("{{ category_labels_json|escapejs }}");
    const categoryValues = JSON.parse("{{ category_values_json|escapejs }}");

    document.getElementById('monthsCount').innerText = months.length;

    // Theme checking helper
    const checkDark = () => document.documentElement.classList.contains('dark');
    const getGridColor = () => checkDark() ? '#334155' : '#e2e8f0';
    const getTextColor = () => checkDark() ? '#cbd5e1' : '#64748b';

    /* =================== MONTHLY LINE CHART =================== */
    const ctxM = document.getElementById('monthlyChart').getContext('2d');
    const monthlyChart = new Chart(ctxM, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Income',
            data: incomeData,
            borderColor: '#10b981', // emerald-500
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          },
          {
            label: 'Expense',
            data: expenseData,
            borderColor: '#ef4444', // red-500
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: getTextColor() }
          },
          tooltip: {
            backgroundColor: checkDark() ? '#1e293b' : '#ffffff',
            titleColor: checkDark() ? '#ffffff' : '#1e293b',
            bodyColor: checkDark() ? '#cbd5e1' : '#475569',
            borderColor: getGridColor(),
            borderWidth: 1
          }
        },
        scales: {
          x: {
            grid: { color: getGridColor(), display: false },
            ticks: { color: getTextColor() }
          },
          y: {
            grid: { color: getGridColor(), borderDash: [5, 5] },
            ticks: { color: getTextColor() },
            beginAtZero: true
          }
        }
      }
    });

    /* =================== CATEGORY PIE CHART =================== */
    const ctxC = document.getElementById('categoryChart').getContext('2d');

    if (categoryValues.length === 0 || categoryValues.every(val => val === 0)) {
      // Show "No Data" message if empty
      const chartContainer = document.getElementById('categoryChart').parentElement;
      chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400 text-sm">No expense data available</div>';
    } else {
      const categoryChart = new Chart(ctxC, {
        type: 'doughnut',
        data: {
          labels: categoryLabels,
          datasets: [{
            data: categoryValues,
            backgroundColor: [
              '#3b82f6', '#8b5cf6', '#ec4899', '#f97316', '#eab308', '#22c55e', '#06b6d4'
            ],
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: getTextColor(), padding: 20 }
            }
          }
        }
      });

      // Theme Change Observer (only if chart exists)
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.attributeName === "class") {
            // Update Line Chart
            if (monthlyChart) {
              monthlyChart.options.scales.x.ticks.color = getTextColor();
              monthlyChart.options.scales.y.ticks.color = getTextColor();
              monthlyChart.options.scales.y.grid.color = getGridColor();
              monthlyChart.options.plugins.legend.labels.color = getTextColor();
              monthlyChart.update();
            }

            // Update Pie Chart
            if (categoryChart) {
              categoryChart.options.plugins.legend.labels.color = getTextColor();
              categoryChart.update();
            }
          }
        });
      });

      observer.observe(document.documentElement, { attributes: true });
    }

    /* =================== FILTER UI =================== */
    const rangeSelect = document.getElementById("rangeSelect");
    const dateInputs = document.getElementById("date-inputs");

    function toggleDates() {
      if (rangeSelect.value === "") {
        dateInputs.style.display = "flex";
      } else {
        dateInputs.style.display = "none";
      }
    }

    rangeSelect.addEventListener("change", toggleDates);
    toggleDates();

  };
</script>
{% endblock %}