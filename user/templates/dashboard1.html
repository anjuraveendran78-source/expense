{% extends 'base_dashboard.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Dashboard - Expense Tracker{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
  <!-- Header Section -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4">
    <div>
      <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Dashboard</h1>
      <p class="text-slate-500 dark:text-slate-400 mt-1">Overview of your financial status</p>
    </div>
    <a href="{% url 'Expense_page' %}"
      class="inline-flex items-center justify-center px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl text-sm font-semibold shadow-lg shadow-emerald-500/30 hover:shadow-emerald-600/40 transition-all transform hover:-translate-y-0.5">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg>
      Add Transaction
    </a>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 transition-all">
    <!-- Balance Card -->
    <div
      class="p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-xl border border-gray-100 dark:border-slate-700 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
      <div
        class="absolute -right-6 -top-6 bg-blue-500/10 w-24 h-24 rounded-full group-hover:bg-blue-500/20 transition-all">
      </div>
      <div class="relative z-10">
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Total Balance</p>
        <h3 class="text-3xl font-bold text-slate-800 dark:text-white">₹ {{ balance|default:"0" }}</h3>
        <div class="mt-4 flex items-center text-sm text-blue-600 dark:text-blue-400">
          <span>Available funds</span>
        </div>
      </div>
      <div class="absolute right-4 bottom-4 text-blue-500/20">
        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
          <path
            d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z">
          </path>
        </svg>
      </div>
    </div>

    <!-- Income Card -->
    <div
      class="p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-xl border border-gray-100 dark:border-slate-700 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
      <div
        class="absolute -right-6 -top-6 bg-emerald-500/10 w-24 h-24 rounded-full group-hover:bg-emerald-500/20 transition-all">
      </div>
      <div class="relative z-10">
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Total Income</p>
        <h3 class="text-3xl font-bold text-emerald-600 dark:text-emerald-400">₹ {{ income_total|default:"0" }}</h3>
        <div class="mt-4 flex items-center text-sm text-emerald-600 dark:text-emerald-400">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6">
            </path>
          </svg>
          <span>Earned</span>
        </div>
      </div>
      <div class="absolute right-4 bottom-4 text-emerald-500/20">
        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"
            clip-rule="evenodd"></path>
        </svg>
      </div>
    </div>

    <!-- Expense Card -->
    <div
      class="p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-xl border border-gray-100 dark:border-slate-700 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
      <div
        class="absolute -right-6 -top-6 bg-red-500/10 w-24 h-24 rounded-full group-hover:bg-red-500/20 transition-all">
      </div>
      <div class="relative z-10">
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Total Expenses</p>
        <h3 class="text-3xl font-bold text-red-600 dark:text-red-400">₹ {{ expense_total|default:"0" }}</h3>
        <div class="mt-4 flex items-center text-sm text-red-600 dark:text-red-400">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6">
            </path>
          </svg>
          <span>Spent</span>
        </div>
      </div>
      <div class="absolute right-4 bottom-4 text-red-500/20">
        <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z"
            clip-rule="evenodd"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- Charts and List Section -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Chart Section -->
    <div
      class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-gray-100 dark:border-slate-700 p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold text-slate-800 dark:text-white">Income vs Expense</h3>
        <!-- Optional: Dropdown for range (visual only for now) -->
      </div>
      <div class="relative h-64 w-full flex justify-center">
        <canvas id="incomeExpenseChart"></canvas>
      </div>
    </div>

    <!-- Recent Transactions -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-gray-100 dark:border-slate-700 p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold text-slate-800 dark:text-white">Recent Transactions</h3>
        <a href="{% url 'Transaction1_page' %}"
          class="text-sm font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400">View All</a>
      </div>

      <div class="space-y-4">
        {% if transactions %}
        {% for t in transactions|slice:":5" %}
        <div
          class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 rounded-full flex items-center justify-center 
                                    {% if t.Type == 'Income' %} bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400
                                    {% else %} bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 {% endif %}">
              {% if t.Type == 'Income' %}
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12">
                </path>
              </svg>
              {% else %}
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6">
                </path>
              </svg>
              {% endif %}
            </div>
            <div>
              <p class="text-sm font-semibold text-slate-800 dark:text-white truncate max-w-[120px]">{{ t.category_id }}
              </p>
              <p class="text-xs text-slate-500 dark:text-slate-400">{{ t.date|date:"M d, Y" }}</p>
            </div>
          </div>
          <div class="text-right">
            <p
              class="text-sm font-bold {% if t.Type == 'Income' %} text-emerald-600 dark:text-emerald-400 {% else %} text-red-600 dark:text-red-400 {% endif %}">
              {% if t.Type == 'Income' %}+{% else %}-{% endif %}₹{{ t.amount }}
            </p>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center py-8">
          <p class="text-slate-500 dark:text-slate-400 text-sm">No transactions yet.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Data from Django Context
    const incomeTotal = parseFloat("{{ income_total|default:'0' }}");
    const expenseTotal = parseFloat("{{ expense_total|default:'0' }}");

    const ctx = document.getElementById('incomeExpenseChart').getContext('2d');

    // Theme aware styling
    const isDark = document.documentElement.classList.contains('dark');
    const gridColor = isDark ? '#334155' : '#e2e8f0';
    const checkDark = () => document.documentElement.classList.contains('dark');

    let myChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Income', 'Expense'],
        datasets: [{
          data: [incomeTotal, expenseTotal],
          backgroundColor: [
            '#10b981', // emerald-500
            '#ef4444'  // red-500
          ],
          borderWidth: 0,
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '75%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: checkDark() ? '#cbd5e1' : '#475569',
              font: {
                family: "'Inter', sans-serif",
                size: 12
              },
              padding: 20
            }
          },
          tooltip: {
            backgroundColor: checkDark() ? '#1e293b' : '#ffffff',
            titleColor: checkDark() ? '#ffffff' : '#1e293b',
            bodyColor: checkDark() ? '#cbd5e1' : '#475569',
            borderColor: checkDark() ? '#334155' : '#e2e8f0',
            borderWidth: 1,
            padding: 10,
            boxPadding: 4,
            callbacks: {
              label: function (context) {
                let label = context.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed !== null) {
                  label += new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed);
                }
                return label;
              }
            }
          }
        }
      }
    });

    // Observer for theme changes to update chart colors dynamically
    const observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        if (mutation.attributeName === "class") {
          const isDarkMode = checkDark();
          myChart.options.plugins.legend.labels.color = isDarkMode ? '#cbd5e1' : '#475569';
          myChart.options.plugins.tooltip.backgroundColor = isDarkMode ? '#1e293b' : '#ffffff';
          myChart.options.plugins.tooltip.titleColor = isDarkMode ? '#ffffff' : '#1e293b';
          myChart.options.plugins.tooltip.bodyColor = isDarkMode ? '#cbd5e1' : '#475569';
          myChart.options.plugins.tooltip.borderColor = isDarkMode ? '#334155' : '#e2e8f0';
          myChart.update();
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true
    });
  });
</script>
{% endblock %}